<tool id="schicexplorer_schiccorrelate" name="@BINARY@" version="@WRAPPER_VERSION@.0">
    <description>correlate scHi-C matrices</description>
    <macros>
        <token name="@BINARY@">scHicCorrelate</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @BINARY@

        --matrix '$matrix_scooler'

        #if $zMin:
            --zMin $zMin
        #end if

        #if $zMax:
            --zMax $zMax
        #end if
        
        --colorMap $colormap
        --plotFileFormat $image_file_format
        $plotNumbers
        --method $method_select
        $log1p
        #if $labels:
            --labels $labels
        #end if
        #if $range_lower and $range_upper:
            --range $range_lower:$range_upper
        #end if
        
        #if $chromosomes:
            #set $chromosome = ' '.join([ '\'%s\'' % $chrom for $chrom in str($chromosomes).split(' ') ])
            --chromosomes $chromosome
        #end if
        --fontsize $fontsize
        --figuresize $figuresize

        --outFileNameHeatmap heatmap.$image_file_format
        --outFileNameScatter scatter.$image_file_format

        --threads @THREADS@

        && mv heatmap.$image_file_format heatmap
        && mv scatter.$image_file_format scatter

    ]]></command>
    <inputs>
        
        <expand macro="matrix_scooler_macro"/>
        <param name="zMin" type="float" value=""  label="zMin" help='Minimum value for the heatmap intensities. If not specified the value is set automatically.' />   
        <param name="zMax" type="float" value=""  label="zMax" help='Maximum value for the heatmap intensities. If not specified the value is set automatically.' />   
        <expand macro="colormap" />
        <param name="image_file_format" type="select" label="Image output format">
            <option value="png" selected="True">png</option>
            <option value="svg">svg</option>
            <option value="pdf">pdf</option>
            <option value="eps">eps</option>
            <option value="emf">emf</option>
        </param>
        <param name='plotNumbers' type='boolean' truevalue='--plotNumbers' falsevalue='' label='Plot numbers' help='If set, then the correlation number is plotted on top of the heatmap.'/>
        <param name="method_select" type="select" label="Correlation method">
            <option value="pearson" selected="True">Pearson</option>
            <option value="spearman">Spearman</option>
        </param>
        <param name='log1p' type='boolean' truevalue='--log1p' falsevalue='' label='Plot numbers' help='If set, then the log1p of the matrix values is used. This parameter has no effect for Spearman correlations but changes the output of Pearson correlation and, for the scatter plot, if set, the visualization of the values is easier.'/>
        <param name="labels" type="text" value=""  label="User defined labels" help='User defined labels instead of default labels from file names. Multiple labels have to be separated by space, e.g. --labels sample1 sample2 sample3' />   
        <param name="range_lower" type="integer" value=""  label="Lower range restriction" help='Only counts within lower:upper range are considered. The range should be adjusted to the size of interacting domains in the genome you are working with.' />   
        <param name="range_upper" type="integer" value=""  label="Upper range restriction" help='Only counts within lower:upper range are considered. The range should be adjusted to the size of interacting domains in the genome you are working with.' />   
        <param name='chromosomes' type='text' label='List of chromosomes to consider' help='Please separate the chromosomes by space'/>
        <param name="fontsize" type="integer" value="15"  label="Font size" /> 
        <param name="figuresize" type="text" value="15 6"  label="Figure size" /> 
    </inputs>
    <outputs>
        <data name="outFileNameHeatmap" from_work_dir="heatmap" format="png" label="${tool.name} on ${on_string}: Heatmap plot">
            <change_format>
                <when input="image_file_format" value="svg" format="svg" />
                <when input="image_file_format" value="pdf" format="pdf" />
                <when input="image_file_format" value="eps" format="eps" />
                <when input="image_file_format" value="emf" format="emf" />
            </change_format>
        </data>
        <data name="outFileNameScatter" from_work_dir="scatter" format="png" label="${tool.name} on ${on_string}: Scatter plot">
            <change_format>
                <when input="image_file_format" value="svg" format="svg" />
                <when input="image_file_format" value="pdf" format="pdf" />
                <when input="image_file_format" value="eps" format="eps" />
                <when input="image_file_format" value="emf" format="emf" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name='matrix_scooler' value='test_matrix.scool' />
            <param name='clusterMethod_selector' value='kmeans' />
            <param name='numberOfClusters' value='3' />
            <param name='distanceShortRange' value='2000000' />
            <param name='distanceLongRange' value='12000000' />

            <output name="outFileName" file="scHicClusterSVL/cluster_kmeans.txt" ftype="txt" compare="sim_size" delta="4000"/>
        </test>

        <test>
            <param name='matrix_scooler' value='test_matrix.scool' />
            <param name='clusterMethod_selector' value='spectral' />
            <param name='numberOfClusters' value='3' />
            <param name='distanceShortRange' value='2000000' />
            <param name='distanceLongRange' value='12000000' />

            <output name="outFileName" file="scHicClusterSVL/cluster_spectral.txt" ftype="txt" compare="sim_size" delta="4000"/>
        </test>
   
    </tests>
    <help><![CDATA[

Clustering with dimension reduction via short vs long range ratio
=================================================================

scHicClusterSVL uses kmeans or spectral clustering to associate each cell to a cluster and therefore to its cell cycle. 
The clustering is applied on dimension reduced data based on the ratio of short vs long range contacts per chromosome. This approach reduces the number of dimensions from samples * (number of bins)^2 to samples * (number of chromosomes). 
Please consider also the other clustering and dimension reduction approaches of the scHicExplorer suite such as `scHicCluster`, `scHicClusterMinHash` and `scHicClusterSVL`. They can give you better results, 
can be faster or less memory demanding.

For more information about scHiCExplorer please consider our documentation on readthedocs.io_

.. _readthedocs.io: http://schicexplorer.readthedocs.io/
]]></help>
    <expand macro="citations" />

</tool>
